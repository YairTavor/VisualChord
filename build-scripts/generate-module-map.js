const fs = require("fs");
const path = require("path");

let imports = "";
let moduleRegistration = "";
let menuItems = "";

const toCamelCase = text => {
  return text.replace(/-\w/g, clearAndUpper);
};

const clearAndUpper = text => {
  return text.replace(/-/, "").toUpperCase();
};

const addImport = (shortName, moduleName) => {
  imports += `\nimport ${moduleName} from "./modules/${shortName}";`;
};

const addModuleRegistration = (shortName, moduleName) => {
  moduleRegistration += `\n\t"${shortName}": ${moduleName},`;
};

const addMenuItem = (shortName, moduleName) => {
  menuItems += `\n\t{ name: "${shortName}", displayName: ${moduleName}.displayName },`;
};

const writeFile = () => {
  const modulesMap = `
/* 
 * This file is auto-generated by a build script. 
 * DO NOT MODIFY. 
 * Just run yarn start to regenerate it.
 */ 
${imports}

// Register all modules here
export default {${moduleRegistration}
}

// expose modules in the menu. name must match the registered module name
export const menuItems = [${menuItems}
];
`;

  fs.writeFileSync("./src/modules-map.js", modulesMap, "utf8");
};

fs.readdir("./src/modules", (err, files) => {
  if (err) {
    throw err;
  }

  files.forEach(file => {
    const extension = path.extname(file);
    if (extension === ".vue") {
      const shortName = file.replace(extension, "");
      const moduleName = toCamelCase(shortName);
      addImport(shortName, moduleName);
      addModuleRegistration(shortName, moduleName);
      addMenuItem(shortName, moduleName);
    }
  });

  writeFile();
});
